name: Scrub Personal Data

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run scrub on'
        required: true
        default: 'main'

jobs:
  scrub:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
      - name: Redact emails and phones in text files
        run: |
          find . -type f -name '*.md' -o -name '*.txt' -o -name '*.env*' | xargs -I{} sed -E -i.bak -e 's/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}/REDACTED_EMAIL/g' {}
          find . -type f -name '*.md' -o -name '*.txt' -o -name '*.env*' | xargs -I{} sed -E -i.bak -e 's/\+?[0-9][0-9()\-\s]{6,}/REDACTED_PHONE/g' {}
          find . -name '*.bak' -delete || true
          git config user.name "scrub-bot"
          git config user.email "scrub-bot@example.com"
          git add -A
          git commit -m "Automated scrub: redact personal info" || echo "No changes"
          git push origin HEAD:scrubbed-${{ github.sha }} || echo "Push may require permissions"
